<!DOCTYPE html>
<html>

  <head>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6195355-4', 'yubico.com');
  ga('send', 'pageview');

</script>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="yubico-piv-tool : Command line tool for the YubiKey NEO PIV applet" />

    <link rel="stylesheet" type="text/css" media="screen" href="/stylesheets/stylesheet.css">

    <title>yubico-piv-tool</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
        <span class="breadcrumb">
          <a href="/">Software listing</a>
          /
          <a href="/yubico-piv-tool/">yubico-piv-tool</a>
          /
          <a>CertificateAuthorityWithNEO</a>
          </span>
          <a id="forkme_banner" href="https://github.com/Yubico/yubico-piv-tool">View on GitHub</a>
<a id="travis_link" href="https://travis-ci.org/Yubico/yubico-piv-tool"><img id="travis_img" src="https://travis-ci.org/Yubico/yubico-piv-tool.svg?branch=master"/></a>
          <h1><a id="project_title" href="/yubico-piv-tool/">yubico-piv-tool</a></h1>
          <h2 id="project_tagline">Command line tool for the YubiKey NEO PIV applet</h2>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
<div class="sect1">
<h2 id="_certificate_authority_with_neo">Certificate Authority with NEO</h2>
<div class="sectionbody">
<div class="paragraph"><p>This document explains how to set up a Certificate Authority (CA) with
Sub-CA private keys stored on YubiKey NEOs.  Typical use for this is
to generate HTTPS certificates for internal servers.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_considerations">Considerations</h2>
<div class="sectionbody">
<div class="paragraph"><p>For our example, we have chosen to use one root CA with a private key
stored in an offline machine, that signs sub-CAs with private keys
stored on YubiKey NEOs, which signs end-entity (EE) certs.  We&#8217;ll
generate the Sub-CA private keys on an offline host and save a copy of
those keys.</p></div>
<div class="paragraph"><p>We have chosen to use a RSA 3744 bit root CA key, and RSA 2048 bit
keys for the NEO Sub-CAs and EE certificates.  The NEO is limited to
RSA 1k and 2k keys (it supports ECDSA too but we chose to not use that
here).</p></div>
<div class="paragraph"><p>By setting some name constraints, we are trying to limit to powers of
this CA.  This is not fully supported by all environments, but it
should do no harm, and may be useful in some environments.</p></div>
<div class="paragraph"><p>The root also has a path length constraint of 1 to prevent the Sub-CAs
from issuing further Sub-Sub-CAs.</p></div>
<div class="paragraph"><p>We&#8217;ll also set a short lifelength on the root CA to signal that expiry
dates on root CAs are not relevant.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_preparations">Preparations</h2>
<div class="sectionbody">
<div class="paragraph"><p>We use OpenSSL to generate keys and certificates.  This is done on an
offline machine, booted from a LiveCD.  Some additional packages may
be required (pcscd, etc, see below) and will have to be transferred on
a USB stick.</p></div>
<div class="paragraph"><p>You need a YubiKey NEO with the PIV applet on, which you can purchase
from Yubico.</p></div>
<div class="paragraph"><p>You need to install the PKCS#11 Engine:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>sudo dpkg -i libengine-pkcs11-openssl*</code></pre>
</div></div>
<div class="paragraph"><p>or if you are on a connected machine, more simpler:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>sudo apt-get install libengine-pkcs11-openssl</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_root_ca">Creating a Root CA</h2>
<div class="sectionbody">
<div class="paragraph"><p>Generate the private key as follows:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>openssl genrsa -out yubico-internal-https-ca-key.pem 3744</code></pre>
</div></div>
<div class="paragraph"><p>Generate the Root CA certificate and initialize the CA serial number
counter as follows:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>cat&gt;yubico-internal-https-ca.conf&lt;&lt;EOF
[ req ]
x509_extensions = v3_ca
distinguished_name = req_distinguished_name
prompt = no
[ req_distinguished_name ]
CN=Yubico Internal HTTPS CA
[ v3_ca ]
subjectKeyIdentifier=hash
basicConstraints = CA:true, pathlen:1
keyUsage=critical, keyCertSign, cRLSign
nameConstraints=@nc
[ nc ]
permitted;otherName=1.3.6.1.5.5.7.8.7;IA5:yubico.com
permitted;email.0=yubico.com
permitted;email.1=.yubico.com
permitted;DNS=yubico.com
permitted;URI.0=yubico.com
permitted;URI.1=.yubico.com
permitted;IP.0=0.0.0.0/255.255.255.255
permitted;IP.1=::/ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
EOF
openssl req -new -sha256 -x509 -set_serial 1 -days 1 -config yubico-internal-https-ca.conf -key yubico-internal-https-ca-key.pem -out yubico-internal-https-ca-crt.pem
echo 01 &gt; yubico-internal-https-ca-crt.srl</code></pre>
</div></div>
<div class="paragraph"><p>You may inspect the newly generated root CA with:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>openssl x509 -text &lt; yubico-internal-https-ca-crt.pem</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_preparing_a_sub_ca_neo">Preparing a Sub-CA NEO</h2>
<div class="sectionbody">
<div class="paragraph"><p>We need to change the management key, PIN and PUK code following the
YubiKey-NEO-PIV-Introduction.txt document.  We also want to save a
copy of these values.  Here are the steps that are needed to be done
for each new Sub-CA NEO.</p></div>
<div class="paragraph"><p>This step is parametrized with the name of the YubiKey NEO user.
Generate new management code, PIN and PUK as follows:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user=Simon
key=`dd if=/dev/random bs=1 count=24 2&gt;/dev/null | hexdump -v -e '/1 "%02X"'`
echo $key &gt; yubico-internal-https-$user-key.txt
pin=`dd if=/dev/random bs=1 count=6 2&gt;/dev/null | hexdump -v -e '/1 "%u"'|cut -c1-6`
echo $pin &gt; yubico-internal-https-$user-pin.txt
puk=`dd if=/dev/random bs=1 count=6 2&gt;/dev/null | hexdump -v -e '/1 "%u"'|cut -c1-8`
echo $puk &gt; yubico-internal-https-$user-puk.txt</code></pre>
</div></div>
<div class="paragraph"><p>Configure a fresh NEO with these parameters as follows:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>yubico-piv-tool -a set-mgm-key -n $key
yubico-piv-tool -k $key -a change-pin -P 123456 -N $pin
yubico-piv-tool -k $key -a change-puk -P 12345678 -N $puk</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_sub_ca">Creating a Sub-CA</h2>
<div class="sectionbody">
<div class="paragraph"><p>This step is parametrized with the name of the YubiKey NEO user.  This
means we will have one Sub-CA for every person authorized to sign
certificates in our CA.</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user=Simon</code></pre>
</div></div>
<div class="paragraph"><p>We first need to load the management key and PIN code from the
previous section.</p></div>
<div class="literalblock">
<div class="content">
<pre><code>key=`cat yubico-internal-https-$user-key.txt`
pin=`cat yubico-internal-https-$user-pin.txt`</code></pre>
</div></div>
<div class="paragraph"><p>Generate the private key:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>openssl genrsa -out yubico-internal-https-subca-$user-key.pem 2048</code></pre>
</div></div>
<div class="paragraph"><p>Generate the Sub-CA certificate request:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>cat&gt;yubico-internal-https-subca-$user-csr.conf&lt;&lt;EOF
[ req ]
distinguished_name = req_distinguished_name
prompt = no
[ req_distinguished_name ]
CN=Yubico Internal HTTPS $user Sub-CA
EOF
openssl req -sha256 -new -config yubico-internal-https-subca-$user-csr.conf -key yubico-internal-https-subca-$user-key.pem -nodes -out yubico-internal-https-subca-$user-csr.pem</code></pre>
</div></div>
<div class="paragraph"><p>Generate the Sub-CA certificate:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>cat&gt;yubico-internal-https-subca-$user-crt.conf&lt;&lt;EOF
basicConstraints = CA:true, pathlen:0
keyUsage=critical, keyCertSign
EOF
openssl x509 -sha256 -CA yubico-internal-https-ca-crt.pem -CAkey yubico-internal-https-ca-key.pem -req -in yubico-internal-https-subca-$user-csr.pem -extfile yubico-internal-https-subca-$user-crt.conf -out yubico-internal-https-subca-$user-crt.pem
echo 00 &gt; yubico-internal-https-subca-$user-crt.srl</code></pre>
</div></div>
<div class="paragraph"><p>You may inspect the newly generated EE cert with this command:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>openssl x509 -text &lt; yubico-internal-https-subca-$user-crt.pem</code></pre>
</div></div>
<div class="paragraph"><p>Import Sub-CA key to NEO:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>yubico-piv-tool -k $key -a import-key -s 9c &lt; yubico-internal-https-subca-$user-key.pem</code></pre>
</div></div>
<div class="paragraph"><p>Import Sub-CA cert to NEO:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>yubico-piv-tool -k $key -a import-certificate -s 9c &lt; yubico-internal-https-subca-$user-crt.pem</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_end_entity_certificates">Creating End-Entity Certificates</h2>
<div class="sectionbody">
<div class="paragraph"><p>This step is parametrized with the hostname, and the name of the
Sub-CA used to sign the EE, so set it first:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>host=munin
user=Simon</code></pre>
</div></div>
<div class="paragraph"><p>We first need to load the PIN code from the previous section.</p></div>
<div class="literalblock">
<div class="content">
<pre><code>pin=`cat yubico-internal-https-$user-pin.txt`</code></pre>
</div></div>
<div class="paragraph"><p>Then generate a new private key and certificate request:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>openssl genrsa -out yubico-internal-https-ee-$host-key.pem 2048
cat&gt;yubico-internal-https-ee-$host-csr.conf&lt;&lt;EOF
[ req ]
distinguished_name = req_distinguished_name
prompt = no
[ req_distinguished_name ]
CN=$host.yubico.com
EOF
openssl req -sha256 -new -config yubico-internal-https-ee-$host-csr.conf -key yubico-internal-https-ee-$host-key.pem -nodes -out yubico-internal-https-ee-$host-csr.pem</code></pre>
</div></div>
<div class="paragraph"><p>Then sign the certificate using the NEO:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>cat&gt;yubico-internal-https-ee-$host-crt.conf&lt;&lt;EOF
EOF
openssl &lt;&lt; EOF
engine dynamic -pre SO_PATH:/usr/lib/engines/engine_pkcs11.so -pre ID:pkcs11 -pre NO_VCHECK:1 -pre LIST_ADD:1 -pre LOAD -pre MODULE_PATH:/usr/lib/x86_64-linux-gnu/opensc-pkcs11.so -pre VERBOSE
x509 -engine pkcs11 -CAkeyform engine -CAkey slot_1-id_2 -sha256 -CA yubico-internal-https-subca-$user-crt.pem -req -passin pass:$pin -in yubico-internal-https-ee-$host-csr.pem -extfile yubico-internal-https-ee-$host-crt.conf -out yubico-internal-https-ee-$host-crt.pem
EOF</code></pre>
</div></div>
<div class="paragraph"><p>You may inspect the newly generated EE cert with this command:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>openssl x509 -text &lt; yubico-internal-https-ee-$host-crt.pem</code></pre>
</div></div>
</div>
</div>

</section>
</div>

<!-- FOOTER  -->
<div id="footer_wrap" class="outer">
<footer class="inner">
<p class="copyright">yubico-piv-tool maintained by <a href="https://github.com/Yubico">Yubico</a></p>
</footer>
</div></body></html>
