<!DOCTYPE html>
<html>

  <head>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6195355-4', 'yubico.com');
  ga('send', 'pageview');

</script>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="yubikey-ksm : YubiKey Key Storage Module" />

    <link rel="stylesheet" type="text/css" media="screen" href="/stylesheets/stylesheet.css">

    <title>yubikey-ksm</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
        <span class="breadcrumb">
          <a href="/">Software listing</a>
          /
          <a href="/yubikey-ksm/">yubikey-ksm</a>
          /
          <a>ServerHardening</a>
          </span>
          <a id="forkme_banner" href="https://github.com/Yubico/yubikey-ksm">View on GitHub</a>
<a id="travis_link" href="https://travis-ci.org/Yubico/yubikey-ksm"><img id="travis_img" src="https://travis-ci.org/Yubico/yubikey-ksm.svg?branch=master"/></a>
          <h1><a id="project_title" href="/yubikey-ksm/">yubikey-ksm</a></h1>
          <h2 id="project_tagline">YubiKey Key Storage Module</h2>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
<div class="sect1">
<h2 id="_server_hardening">Server Hardening</h2>
<div class="sectionbody">
<div class="paragraph"><p>While the defaults should be secure, there are some simple
administrative actions that will increase your overall security.  None
of these steps are required, but we encourage you to read this
document to see if the enhancements are relevant for your environment.</p></div>
<div class="sect2">
<h3 id="_tighten_php_configuration">Tighten PHP configuration</h3>
<div class="paragraph"><p>Tighten the security of the PHP installation by creating a file
/etc/php5/conf.d/harden.ini with the following content:</p></div>
<div class="literalblock">
<div class="content">
<pre><code> &lt;nowiki&gt;
 user@host:~$ sudo sh -c 'cat &gt; /etc/php5/conf.d/harden.ini'
 display_errors = Off
 log_errors = On
 user@host:~$
&lt;/nowiki&gt;</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_tighten_apache_configuration">Tighten Apache configuration</h3>
<div class="paragraph"><p>Tighten the security of the Apache installation by making sure
directory listings are disabled globally.  Edit
/etc/apache2/conf.d/security and make sure the following is
uncommented:</p></div>
<div class="literalblock">
<div class="content">
<pre><code> &lt;nowiki&gt;
 &lt;Directory /&gt;
        AllowOverride None
        Order Deny,Allow
        Deny from all
 &lt;/Directory&gt;
&lt;/nowiki&gt;</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_time_synchronization">Time synchronization</h3>
<div class="paragraph"><p>For logging and (on the validation server) time-stamping it is
important to have synchronized clocks.  Install ntp.</p></div>
<div class="literalblock">
<div class="content">
<pre><code> &lt;nowiki&gt;
 user@host:~$ sudo apt-get install ntp
 ...
&lt;/nowiki&gt;</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_firewall">Firewall</h3>
<div class="paragraph"><p>There is no reason why the KSM needs to listen to incoming requests
from the entire Internet, and restricting access to the intended
YK-VAL servers are recommended.</p></div>
<div class="literalblock">
<div class="content">
<pre><code> &lt;nowiki&gt;
 user@ksm:~$ sudo sh -c 'cat &gt; /etc/network/if-pre-up.d/iptables'
 #!/bin/sh
 # IPv4 firewall:
 iptables -F
 iptables -P INPUT DROP
 iptables -P FORWARD DROP
 iptables -P OUTPUT ACCEPT
 iptables -A INPUT -i lo -p all -j ACCEPT
 iptables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
 iptables -A INPUT -p tcp -i eth0 -s 1.2.3.4 --dport 22 -j ACCEPT
 iptables -A INPUT -p tcp -i eth0 -s 2.3.4.5 --dport 80 -j ACCEPT
 iptables -A INPUT -p tcp -i eth0 -s 2.3.4.5 --dport 443 -j ACCEPT
 # IPv6 firewall:
 ip6tables -F
 ip6tables -P INPUT DROP
 ip6tables -P FORWARD DROP
 ip6tables -P OUTPUT ACCEPT
 ip6tables -A INPUT -i lo -p all -j ACCEPT
 ip6tables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
 ip6tables -A INPUT -p icmpv6 -j ACCEPT
 ip6tables -A INPUT -p tcp -i eth0 -s 2000:1:2::3 --dport 22 -j ACCEPT
 ip6tables -A INPUT -p tcp -i eth0 -s 2000:2:3::4 --dport 80 -j ACCEPT
 ip6tables -A INPUT -p tcp -i eth0 -s 2000:2:3::4 --dport 443 -j ACCEPT
 user@ksm:~$ chmod +x /etc/network/if-pre-up.d/iptables
 user@ksm:~$
&lt;/nowiki&gt;</code></pre>
</div></div>
<div class="paragraph"><p>Replace 1.2.3.4 (for IPv4) and 2000:1:2::3 (for IPv6) with the address
of the host you want to be able to login from via SSH, and replace
2.3.4.5 (for IPv4) and 2000:2:3::4 (for IPv6) with the address of the
YK-VAL that will be accessing this YK-KSM.  Add more lines for each
validation server and SSH host.</p></div>
<div class="paragraph"><p>For a validation server, you may want to allow HTTP(S) requests from
anyone, but not anything else.</p></div>
<div class="literalblock">
<div class="content">
<pre><code> &lt;nowiki&gt;
 user@val:~$ sudo sh -c 'cat &gt; /etc/network/if-pre-up.d/iptables'
 #!/bin/sh
 # IPv4 firewall
 iptables -F
 iptables -P INPUT DROP
 iptables -P FORWARD DROP
 iptables -P OUTPUT ACCEPT
 iptables -A INPUT -i lo -p all -j ACCEPT
 iptables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
 iptables -A INPUT -p tcp -i eth0 -s 1.2.3.4 --dport 22 -j ACCEPT
 iptables -A INPUT -p tcp -i eth0 --dport 80 -j ACCEPT
 iptables -A INPUT -p tcp -i eth0 --dport 443 -j ACCEPT
 # IPv6 firewall:
 ip6tables -F
 ip6tables -P INPUT DROP
 ip6tables -P FORWARD DROP
 ip6tables -P OUTPUT ACCEPT
 ip6tables -A INPUT -i lo -p all -j ACCEPT
 ip6tables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
 ip6tables -A INPUT -p icmpv6 -j ACCEPT
 ip6tables -A INPUT -p tcp -i eth0 -s 2000:1:2::3 --dport 22 -j ACCEPT
 ip6tables -A INPUT -p tcp -i eth0 --dport 80 -j ACCEPT
 ip6tables -A INPUT -p tcp -i eth0 --dport 443 -j ACCEPT
 user@ksm:~$ chmod +x /etc/network/if-pre-up.d/iptables
 user@ksm:~$
&lt;/nowiki&gt;</code></pre>
</div></div>
<div class="paragraph"><p>Again, replace 1.2.3.4 (for IPv4) and 2000:1:2::3 (for IPv6) with the
address of the host you want to be able to login from via SSH.</p></div>
<div class="paragraph"><p>If you want to allow SSH and HTTP(S) from everywhere, but nothing
else, try this:</p></div>
<div class="literalblock">
<div class="content">
<pre><code> &lt;nowiki&gt;
 user@val:~$ sudo sh -c 'cat &gt; /etc/network/if-pre-up.d/iptables'
 #!/bin/sh
 # IPv4 firewall
 iptables -F
 iptables -P INPUT DROP
 iptables -P FORWARD DROP
 iptables -P OUTPUT ACCEPT
 iptables -A INPUT -i lo -p all -j ACCEPT
 iptables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
 iptables -A INPUT -p tcp -i eth0 --dport 22 -j ACCEPT
 iptables -A INPUT -p tcp -i eth0 --dport 80 -j ACCEPT
 iptables -A INPUT -p tcp -i eth0 --dport 443 -j ACCEPT
 # IPv6 firewall:
 ip6tables -F
 ip6tables -P INPUT DROP
 ip6tables -P FORWARD DROP
 ip6tables -P OUTPUT ACCEPT
 ip6tables -A INPUT -i lo -p all -j ACCEPT
 ip6tables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
 ip6tables -A INPUT -p icmpv6 -j ACCEPT
 ip6tables -A INPUT -p tcp -i eth0 --dport 22 -j ACCEPT
 ip6tables -A INPUT -p tcp -i eth0 --dport 80 -j ACCEPT
 ip6tables -A INPUT -p tcp -i eth0 --dport 443 -j ACCEPT
 user@ksm:~$ chmod +x /etc/network/if-pre-up.d/iptables
 user@val:~$
&lt;/nowiki&gt;</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_database_encryption">Database encryption</h3>
<div class="paragraph"><p>The database contains sensitive information.  If someone is able to
access your machine physically, they may shut it off and steal it with
the goal of reading out the sensitive information.  By encrypting the
disk, you can prevent this.  Note that this does not protect against
an attacker who has physical access to your server and sufficient time
to read out the data from the already running system.</p></div>
<div class="paragraph"><p>Full disk encryption will give you the highest protection, but
requires that you can enter the disk encryption password on each
power-up.  This can be unpractical when your hosting environment is
remote.</p></div>
<div class="paragraph"><p>Partial disk encryption allows the operating system to start up, and
enable you to login to the machine remotely to enter the disk
encryption password.  This is less secure than full disk encryption,
because an attacker could physically disconnect your machine, modify
the operating system to send a copy of the password to the attacker,
but may be sufficient if you keep good track of when your machine is
not working properly.</p></div>
<div class="paragraph"><p>To use partial disk encryption for the database content, we suggest
you install the operating system as normal but create another file
system on an encrypted volume.</p></div>
<div class="paragraph"><p>If you need swap space, be sure to only put the swap on the encrypted
volume too.  Make sure that the database does not start up
automatically on boot, and also make sure that the system does not
attempt to mount your encrypted partition automatically.</p></div>
<div class="paragraph"><p>Setup:</p></div>
<div class="literalblock">
<div class="content">
<pre><code> &lt;nowiki&gt;
 user@ksm:~$ sudo apt-get install loop-aes-utils loop-aes-modules-2.6-amd64
 ...
 user@ksm:~$ sudo rmmod loop &amp;&amp; sudo modprobe loop
 user@ksm:~$ sudo dd if=/dev/zero of=/root/ksm.img bs=1k count=1M
 ...
 user@ksm:~$ sudo losetup -e AES128 /dev/loop0 /root/ksm.img
 Password:
 user@ksm:~$ sudo mkfs.ext2 -q /dev/loop0
 user@ksm:~$ sudo mkdir /ksm
 user@ksm:~$ sudo mount /dev/loop0 /ksm
 user@ksm:~$ sudo /etc/init.d/postgresql-8.3 stop
 ...
 user@ksm:~$ sudo update-rc.d -f postgresql-8.3 remove
 user@ksm:~$ sudo mv /var/lib/postgresql /ksm
 user@ksm:~$ sudo ln -s /ksm/postgresql /var/lib/postgresql
 user@ksm:~$ sudo sh -c 'cat &gt; /usr/local/sbin/ykksm-start'
 #!/bin/sh
 set -e
 set -x
 losetup -e AES128 /dev/loop0 /root/ksm.img
 fsck /dev/loop0
 mount /dev/loop0  /ksm/
 /etc/init.d/postgresql-8.3 start
 user@ksm:~$ sudo sh -c 'cat &gt; /usr/local/sbin/ykksm-stop'
 #!/bin/sh
 set -e
 set -x
 /etc/init.d/postgresql-8.3 stop
 umount /ksm
 losetup -d /dev/loop0
 user@ksm:~$ sudo chmod +x /usr/local/sbin/ykksm-{start,stop}
&lt;/nowiki&gt;</code></pre>
</div></div>
<div class="paragraph"><p>Slightly adapted for MySQL:</p></div>
<div class="literalblock">
<div class="content">
<pre><code> &lt;nowiki&gt;
 user@ksm:~$ sudo apt-get install loop-aes-utils loop-aes-modules-2.6-686
 ...
 user@ksm:~$ sudo rmmod loop &amp;&amp; sudo modprobe loop
 user@ksm:~$ sudo dd if=/dev/zero of=/root/ksm.img bs=1k count=1M
 ...
 user@ksm:~$ sudo losetup -e AES128 /dev/loop0 /root/ksm.img
 Password:
 user@ksm:~$ sudo mkfs.ext2 -q /dev/loop0
 user@ksm:~$ sudo mkdir /ksm
 user@ksm:~$ sudo mount /dev/loop0 /ksm
 user@ksm:~$ sudo /etc/init.d/mysql stop
 user@ksm:~$ sudo update-rc.d -f mysql remove
 user@ksm:~$ sudo mv /var/lib/mysql /ksm
 user@ksm:~$ sudo ln -s /ksm/mysql /var/lib/mysql
 user@ksm:~$ sudo sh -c 'cat &gt; /usr/local/sbin/ykksm-start'
 #!/bin/sh
 set -e
 set -x
 losetup -e AES128 /dev/loop0 /root/ksm.img
 fsck /dev/loop0
 mount /dev/loop0  /ksm/
 /etc/init.d/mysql start
 user@ksm:~$ sudo sh -c 'cat &gt; /usr/local/sbin/ykksm-stop'
 #!/bin/sh
 set -e
 set -x
 /etc/init.d/mysql stop
 umount /ksm
 losetup -d /dev/loop0
 user@ksm:~$ sudo chmod +x /usr/local/sbin/ykksm-{start,stop}
&lt;/nowiki&gt;</code></pre>
</div></div>
<div class="paragraph"><p>Then in the future, to start the YK-KSM, you will need to login to the
machine and issue the command <em>sudo ykksm-start</em> and enter the disk
encryption password.</p></div>
<div class="paragraph"><p>Again, make sure that you don&#8217;t use any unencrypted swap.</p></div>
</div>
<div class="sect2">
<h3 id="_intrusion_detection">Intrusion detection</h3>
<div class="paragraph"><p>To make some attacks discussed in the previous section harder, make
sure that your system has a hardware intrusion detection system and
that your software is notified when it is triggered.  When the
intrusion detection is triggered, you should stop the database and
unmount the encrypted volume and send out a signal to your
administrators.</p></div>
</div>
</div>
</div>

</section>
</div>

<!-- FOOTER  -->
<div id="footer_wrap" class="outer">
<footer class="inner">
<p class="copyright">yubikey-ksm maintained by <a href="https://github.com/Yubico">Yubico</a></p>
</footer>
</div></body></html>
