<!DOCTYPE html>
<html>

  <head>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6195355-4', 'yubico.com');
  ga('send', 'pageview');

</script>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="yubikey-ksm : YubiKey Key Storage Module" />

    <link rel="stylesheet" type="text/css" media="screen" href="/stylesheets/stylesheet.css">

    <title>yubikey-ksm</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
        <span class="breadcrumb">
          <a href="/">Software listing</a>
          /
          <a href="/yubikey-ksm/">yubikey-ksm</a>
          /
          <a>Installation</a>
          </span>
          <a id="forkme_banner" href="https://github.com/Yubico/yubikey-ksm">View on GitHub</a>
<a id="travis_link" href="https://travis-ci.org/Yubico/yubikey-ksm"><img id="travis_img" src="https://travis-ci.org/Yubico/yubikey-ksm.svg?branch=master"/></a>
          <h1><a id="project_title" href="/yubikey-ksm/">yubikey-ksm</a></h1>
          <h2 id="project_tagline">YubiKey Key Storage Module</h2>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
<div class="sect1">
<h2 id="_installation_and_configuration_of_yubikey_ksm">Installation and Configuration of Yubikey KSM</h2>
<div class="sectionbody">
<div class="paragraph"><p>The Yubikey KSM module is responsible for storing AES keys and
providing two interfaces:</p></div>
<div class="ulist"><ul>
<li>
<p>
Decrypting an OTP
</p>
</li>
<li>
<p>
Adding new AES keys
</p>
</li>
</ul></div>
<div class="paragraph"><p>It is intentionally not possible to extract the AES keys or to make
modifications to the database content, see <a id="DesignGoals"></a>.</p></div>
<div class="paragraph"><p>The installation procedure documented below applies to any Unix-like
environment, although it was written for Debian GNU/Linux version 5.0
(aka "lenny").</p></div>
<div class="paragraph"><p>Since version 1.1 of the YK-KSM, any database supported by the PHP PDO
interface is supported by the YK-KSM.  To give concrete examples, we
will here explain how to set it up using MySQL or PostgreSQL.  Note
that you only need to install either MySQL or PostgreSQL (or any other
supported database), not both!</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_step_1_yk_ksm_installation">Step 1: YK-KSM Installation</h2>
<div class="sectionbody">
<div class="paragraph"><p>First you should download and install the latest YK-KSM release:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ sudo apt-get install wget make help2man
...
user@ksm:~$ wget http://yubico.github.com/yubikey-ksm/releases/yubikey-ksm-1.8.tgz
...
user@ksm:~$ tar xfz yubikey-ksm-1.8.tgz
user@ksm:~$ cd yubikey-ksm-1.8
user@ksm:~/yubikey-ksm-1.8$ sudo make install
...
user@ksm:~/yubikey-ksm-1.8$</code></pre>
</div></div>
<div class="paragraph"><p>Alternatively, you may also check out YK-KSM from its source code repository.  For example:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ sudo apt-get install git make help2man
...
user@ksm:~$ git clone git://github.com/Yubico/yubikey-ksm.git
...
user@ksm:~$ cd yubikey-ksm
user@ksm:~/yubikey-ksm$ sudo make install
...
user@ksm:~/yubikey-ksm$</code></pre>
</div></div>
<div class="paragraph"><p>The rest of this documentation will assume you have installed the
YK-KSM with <em>make install</em>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_step_2_install_web_server_and_php">Step 2: Install web server and PHP</h2>
<div class="sectionbody">
<div class="paragraph"><p>You will need to install a web server with PHP5 and the PHP mcrypt
interface:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ sudo apt-get install apache2 php5 php5-mcrypt</code></pre>
</div></div>
<div class="paragraph"><p>Any web server with PHP support should work.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_step_3a_mysql_installation">Step 3A: MySQL Installation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Install the required packages:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ sudo apt-get install mysql-server php5-mysql libdbd-mysql-perl
...
user@ksm:~$</code></pre>
</div></div>
<div class="paragraph"><p>The installation asks you for a MySQL "root" password, and I recommend
to specify one.</p></div>
<div class="paragraph"><p>To avoid having to specify a password when using the <em>mysql</em> tool
interactively, you can store the password in ~/.my.cnf, see
/usr/share/doc/mysql-server-5.0/README.Debian.gz.  For example:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ cat &gt; .my.cnf
[client]
user = root
password = YOURPASSWORD
user@ksm:~$</code></pre>
</div></div>
<div class="paragraph"><p>First create the database and the tables as follows:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ echo 'create database ykksm' | mysql
user@ksm:~$ mysql ykksm &lt; /usr/share/doc/yubikey-ksm/ykksm-db.sql
user@ksm:~$</code></pre>
</div></div>
<div class="paragraph"><p>You should also create database users for the decrypt and import
interfaces, normally called <em>ykksmreader</em> and <em>ykksmimporter</em>:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ mysql --silent ykksm
mysql&gt; CREATE USER 'ykksmreader';
mysql&gt; GRANT SELECT ON ykksm.yubikeys TO 'ykksmreader'@'localhost';
mysql&gt; SET PASSWORD FOR 'ykksmreader'@'localhost' = PASSWORD('yourpassword');
mysql&gt; CREATE USER 'ykksmimporter';
mysql&gt; GRANT INSERT ON ykksm.yubikeys TO 'ykksmimporter'@'localhost';
mysql&gt; SET PASSWORD FOR 'ykksmimporter'@'localhost' = PASSWORD('otherpassword');
mysql&gt; FLUSH PRIVILEGES;
mysql&gt; \q
user@ksm:~$</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_step_3b_postgresql_installation">Step 3B: PostgreSQL Installation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Install some packages:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ sudo apt-get install postgresql php5-pgsql libdbd-pg-perl
...
user@ksm:~$</code></pre>
</div></div>
<div class="paragraph"><p>The database needs to be initialized as follows:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ sudo su postgres
postgres@ksm:~$ createdb ykksm
postgres@ksm:~$ psql ykksm &lt; /usr/share/doc/yubikey-ksm/ykksm-db.sql
postgres@ksm:~$</code></pre>
</div></div>
<div class="paragraph"><p>You also need to create a user for the decrypt interface, normally
called <em>ykksmreader</em>:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>postgres@ksm:~$ psql ykksm -q
ykksm=# CREATE USER ykksmreader PASSWORD 'yourpassword';
ykksm=# GRANT SELECT ON yubikeys TO ykksmreader;
ykksm=# CREATE USER ykksmimporter PASSWORD 'otherpassword';
ykksm=# GRANT INSERT ON yubikeys TO ykksmimporter;
ykksm=# \q
postgres@ksm:~$</code></pre>
</div></div>
<div class="paragraph"><p>During installation and debugging it may be useful to watch the
database log entries:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ sudo tail -F /var/log/postgresql/postgresql-*-main.log &amp;</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_step_4_include_path_configuration">Step 4: Include path configuration</h2>
<div class="sectionbody">
<div class="paragraph"><p>Set the include path by creating a file /etc/php5/conf.d/ykksm.ini
with the following content:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ sudo sh -c 'cat &gt; /etc/php5/conf.d/ykksm.ini'
include_path = "/etc/yubico/ksm:/usr/share/yubikey-ksm"
user@ksm:~$ sudo /etc/init.d/apache2 restart
user@ksm:~$</code></pre>
</div></div>
<div class="paragraph"><p>The paths are the default, if you installed the YK-KSM in some other
place you need to modify the paths.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_step_5_logging">Step 5: Logging</h2>
<div class="sectionbody">
<div class="paragraph"><p>The PHP interface uses syslog for logging of incoming requests.  The
facility is set in ykksm-config.php but defaults the LOG_LOCAL0.  To
place these messages in a separate file, you can add the following to
/etc/syslog.conf, or if you use rsyslog, create a file
/etc/rsyslog.d/ykksm.conf with this content:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ sudo sh -c 'cat &gt; /etc/rsyslog.d/ykksm.conf'
local0.* -/var/log/ykksm.log
user@ksm:~$ sudo /etc/init.d/rsyslog restart
...
user@ksm:~$</code></pre>
</div></div>
<div class="paragraph"><p>The <em>-</em> before the filename avoids syncing the file after each write,
which is recommended for performance.</p></div>
<div class="paragraph"><p>The log file can grow large quickly, so it is a good idea to setup
rotation of log files.  Here is an example that rotates the log file
weekly.  Create a file /etc/logrotate.d/ykksm like this:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ sudo sh -c 'cat &gt; /etc/logrotate.d/ykksm'
/var/log/ykksm.log {
       weekly
       missingok
       rotate 9999
       notifempty
       postrotate
               invoke-rc.d rsyslog reload &gt; /dev/null
       endscript
}
user@ksm:~$</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_step_5_1_fix_default_log_optional">Step 5.1: Fix default log (optional)</h2>
<div class="sectionbody">
<div class="paragraph"><p>Unfortunately, most default syslog configuration, including the
syslog.conf configuration file on Debian, will also log all entries to
/var/log/syslog and/or /var/log/messages.</p></div>
<div class="paragraph"><p>I am not aware of any way to avoid this without modifying these other
rules.  To avoid YK-KSM log entries in these other files, you must
modify the default rules.  For example, edit the following lines of
/etc/rsyslog.conf (or /etc/syslog.conf if you don&#8217;t use rsyslog):</p></div>
<div class="literalblock">
<div class="content">
<pre><code>*.*;auth,authpriv.none          -/var/log/syslog
*.=info;*.=notice;*.=warn;\
        auth,authpriv.none;\
        cron,daemon.none;\
        mail,news.none          -/var/log/messages</code></pre>
</div></div>
<div class="paragraph"><p>Change them into:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>*.*;auth,authpriv.none,local0.none              -/var/log/syslog
*.=info;*.=notice;*.=warn;\
        auth,authpriv.none;\
        cron,daemon.none;\
        local0.none;\
        mail,news.none          -/var/log/messages</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_step_6_decrypt_otp_interface">Step 6: Decrypt OTP Interface</h2>
<div class="sectionbody">
<div class="paragraph"><p>The interface to decrypt OTPs is implemented using a PHP script.  You
can place the script under any URL, but we recommend serving it as
<a href="http://ykksm.example.org/wsapi/decrypt">http://ykksm.example.org/wsapi/decrypt</a>.  The simplest way is to use
the <em>symlink</em> rule in our makefile:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ sudo make -f /usr/share/doc/yubikey-ksm/ykksm.mk symlink
install -d /var/www/wsapi
ln -sf /usr/share/yubikey-ksm/.htaccess /var/www/wsapi/.htaccess
ln -sf /usr/share/yubikey-ksm/ykksm-decrypt.php /var/www/wsapi/decrypt.php
user@ksm:~$</code></pre>
</div></div>
<div class="paragraph"><p>You may also run the commands manually.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_step_7_yk_ksm_configuration">Step 7: YK-KSM Configuration</h2>
<div class="sectionbody">
<div class="paragraph"><p>You need to edit the ykksm-config.php script.  An example file is
included in YK-KSM as <em>ykksm-config.php</em>.  It is normally installed as
/etc/yubico/ksm/ykksm-config.php:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ sudo cat /etc/yubico/ksm/ykksm-config.php
&lt;?php
$db_dsn      = "mysql:dbname=ykksm;host=127.0.0.1";
$db_username = "ykksmreader";
$db_password = "yourpassword";
$db_options  = array();
$logfacility = LOG_LOCAL0;
?&gt;
user@ksm:~$</code></pre>
</div></div>
<div class="paragraph"><p>Be careful about the user permissions and ownership so that unrelated
users on the system cannot read the database password.</p></div>
<div class="paragraph"><p>Typically you only need to modify the database password, and possibly
the database definition in $db_dsn.  Example DSN for a MySQL setup:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>$db_dsn      = "mysql:dbname=ykksm;host=127.0.0.1";</code></pre>
</div></div>
<div class="paragraph"><p>An example DSN for a PostgreSQL setup:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>$db_dsn      = "pgsql:dbname=ykksm;host=127.0.0.1";</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_the_end">The End</h2>
<div class="sectionbody">
<div class="paragraph"><p>You now have a YK-KSM up and running.  You can test the service by
requesting a URL.  Using wget, for example:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>user@ksm:~$ sudo apt-get install wget
user@ksm:~$ wget -q -O - 'http://localhost/wsapi/decrypt?otp=dteffujehknhfjbrjnlnldnhcujvddbikngjrtgh'
ERR Unknown yubikey
user@ksm:~$</code></pre>
</div></div>
<div class="paragraph"><p>You will need to import keys into the database for the decrypt
function to do anything useful.  See <a id="ServerHardening"></a> on how to
improve security of your system.  Likely next steps are
<a id="GenerateKSMKey"></a>, <a id="GenerateKeys"></a> and/or <a id="ImportKeysToKSM"></a>.</p></div>
</div>
</div>

</section>
</div>

<!-- FOOTER  -->
<div id="footer_wrap" class="outer">
<footer class="inner">
<p class="copyright">yubikey-ksm maintained by <a href="https://github.com/Yubico">Yubico</a></p>
</footer>
</div></body></html>
