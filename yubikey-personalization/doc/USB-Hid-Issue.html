
<!DOCTYPE html>
<html>

  <head>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6195355-4', 'yubico.com');
  ga('send', 'pageview');

</script>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="yubikey-personalization : YubiKey Personalization cross-platform library and tool" />

    <link rel="stylesheet" type="text/css" media="screen" href="/stylesheets/stylesheet.css">

    <title>yubikey-personalization</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/Yubico/yubikey-personalization">View on GitHub</a>

          <h1 id="project_title">yubikey-personalization</h1>
          <h2 id="project_tagline">YubiKey Personalization cross-platform library and tool</h2>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>A quirk with the usbhid module on Linux</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_the_problem">The problem</h2>
<div class="sectionbody">
<div class="paragraph"><p>It seems like the Linux kernel takes exclusive ownership over the
YubiKey, making it difficult for our programs to talk with it.</p></div>
<div class="paragraph"><p>When looking in /var/log/syslog or /var/log/messages, you might see a
message like the following:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>  Jun 29 13:17:22 lapdog vmunix: [  738.648591] usb 3-3: usbfs: process 10782 (mini) did not claim interface 0 before use</tt></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_real_solution_1">Real Solution 1</h2>
<div class="sectionbody">
<div class="paragraph"><p>To get it to work with libusb 0.1, a <a href="https://github.com/Yubico/yubikey-personalization/commit/919d5ad91365337f33c1abbdb30474f5373194e1">small fix</a> to the library was all that
was needed.  This is now fixed in the main distribution, since version 1.4.0.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_real_solution_2">Real Solution 2</h2>
<div class="sectionbody">
<div class="paragraph"><p>Install libusb-1.0 and re-build ykpersonalize, and make sure it is
using the "libusb-1.0" backend rather than the "libusb" backend.</p></div>
<div class="paragraph"><p>This backend has been added recently, but appears to solve the problem
in a clean way.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The "libusb-1.0" library is different from the traditional
"libusb" library.  Install it on Debian/Ubuntu systems like this:</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content">
<pre><tt>sudo apt-get install libusb-1.0-0-dev</tt></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_workaround_1">Workaround 1</h2>
<div class="sectionbody">
<div class="paragraph"><p>There&#8217;s a workaround, though, to set a quirks mode for the key, as
follows:</p></div>
<div class="paragraph"><p>---
  rmmod usbhid &amp;&amp; modprobe usbhid quirks=0x1050:0x0010:0x04
---</p></div>
<div class="paragraph"><p>In that mode, though, the YubiKey will not work as a keyboard and
therefore not generate any string at all, so to have it work as usual
again, you&#8217;ll have to take usbhid out of quirks more:</p></div>
<div class="paragraph"><p>---
  rmmod usbhid &amp;&amp; modprobe usbhid
---</p></div>
<div class="paragraph"><p>The above quirk only works on kernels up to 2.6.26.  We have yet to
find out exactly what changed on newer versions and how to get around
it again.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_workaround_2">Workaround 2</h2>
<div class="sectionbody">
<div class="paragraph"><p>User t.bubeck contributed the following, arguable better solution:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Get the USB device numbers with the following command:
</p>
</li>
</ol></div>
<div class="listingblock">
<div class="content">
<pre><tt># dmesg | grep Yubi
[314508.442312] input: Yubico Yubico Yubikey Touch as /devices/pci0000:00/0000:00:1d.2/usb4/4-1/4-1:1.0/input/input119
[314508.448287] generic-usb 0003:1050:0010.006F: input,hidraw1: USB HID v1.11 Keyboard [Yubico Yubico Yubikey Touch] on usb-0000:00:1d.2-1/input0</tt></pre>
</div></div>
<div class="paragraph"><p>Then unbind your YubiKey by using your numbers instead of the example
given here:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt># echo 4-1:1.0 &gt; /sys/bus/usb/drivers/usbhid/unbind</tt></pre>
</div></div>
<div class="paragraph"><p>David Dindorp has contributed a small script that unbinds YubiKeys as
they are plugged in, for use during personalization.  See:</p></div>
<div class="paragraph"><p><a href="https://github.com/Yubico/yubikey-personalization/blob/master/contrib/programming.sh">https://github.com/Yubico/yubikey-personalization/blob/master/contrib/programming.sh</a></p></div>
<div class="paragraph"><p>Start the script as root (e.g., using "sudo programming.sh") and let
it run, it will print status information as it unbinds newly connected
YubiKeys.</p></div>
</div>
</div>

</section>
</div>

<!-- FOOTER  -->
<div id="footer_wrap" class="outer">
<footer class="inner">
<p class="copyright">yubikey-personalization maintained by <a href="https://github.com/Yubico">Yubico</a></p>
<p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
</footer>
</div></body></html>
