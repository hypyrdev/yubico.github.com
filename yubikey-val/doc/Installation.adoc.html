<!DOCTYPE html>
<html>

  <head>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6195355-4', 'yubico.com');
  ga('send', 'pageview');

</script>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="yubikey-val : YubiKey OTP validation server in PHP" />

    <link rel="stylesheet" type="text/css" media="screen" href="/stylesheets/stylesheet.css">

    <title>yubikey-val</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
        <span class="breadcrumb">
          <a href="/">Software listing</a>
          /
          <a href="/yubikey-val/">yubikey-val</a>
          /
          <a>Installation.adoc</a>
          </span>
          <a id="forkme_banner" href="https://github.com/Yubico/yubikey-val">View on GitHub</a>
<a id="travis_link" href="https://travis-ci.org/Yubico/yubikey-val"><img id="travis_img" src="https://travis-ci.org/Yubico/yubikey-val.svg?branch=master"/></a>
          <h1><a id="project_title" href="/yubikey-val/">yubikey-val</a></h1>
          <h2 id="project_tagline">YubiKey OTP validation server in PHP</h2>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>This document describes how to get one instance of the Yubikey
Validation Server (YK-VAL) up and running.</p></div>
<div class="paragraph"><p>The purpose of the Yubikey validation server is to validate Yubikey
OTPs.  The validation server is written in PHP, and thus needs a web
server and a database.  We will use Apache and MySQL, but with small
modifications it should be possible to use with other implementations
too (e.g., lighttpd and PostgreSQL).</p></div>
<div class="paragraph"><p>The validation server needs to talk to a Yubikey Key Storage Module
(YK-KSM) to work.  Thus, you either need to arrange for access to a
remote YK-KSM and get the URL to it, or install your own YK-KSM.</p></div>
<div class="paragraph"><p>Currently there are two recommended implementations of a YK-KSM.  If you have a YubiHSM hardware dongle and want improve security, we recommend using Python-PyHSM:</p></div>
<div class="paragraph"><p>Otherwise we recommend the "soft" YK-KSM:</p></div>
<div class="paragraph"><p>The YK-KSM can be on the same machine as the validation server, but
for improved security we recommend to use different machines for the
validation server and the KSM.</p></div>
<div class="paragraph"><p>The OTP validation service is delivered through web service API.
There&#8217;s no web-based HTML form interface involved.  The protocol is
defined at:</p></div>
<div class="paragraph"><p>For redundancy it is possible to set up multiple instances of the
YubiKey Validation Server.  The intent is that clients should be able
to continue validate OTPs even if one of the servers are down.  This
is reflected in the configuration of a YK-VAL by having a "sync pool"
concept.  The sync pool of a particular YK-VAL instance is a list of
URLs that the local server will synchronize the OTP with, depending on
client request.  Normally if you have 5 servers, each server will have
a list of the 4 other servers in its sync pool&#8201;&#8212;&#8201;however it IS
possible to deviate from this if for some reason it is not possible to
reach one particular server from one of the servers.  For simplicity,
we strongly recommend you to list non-local servers in each sync pool
though.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">Installation</h2>
<div class="sectionbody">
<div class="paragraph"><p>This following steps applies to any GNU/Linux-like system, although it
was written for Debian GNU/Linux.  If you do not know which OS to use,
we recommend a default choice of Ubuntu 12.04 LTS since it is a
well-known distribution that comes with 5 years of security support.
Install the OS following its manual and enable automatic security
upgrades if prompted.</p></div>
<div class="sect2">
<h3 id="_step_1_yk_val_installation">Step 1: YK-VAL Installation</h3>
<div class="paragraph"><p>First you should download and install the latest YK-VAL release:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ sudo apt-get install git make
&#8230;
<a href="mailto:user@val">user@val</a>:</sub>$ git clone git://github.com/Yubico/yubikey-val.git
&#8230;
<a href="mailto:user@val">user@val</a>:<sub>$ cd yubikey-val
<a href="mailto:user@val">user@val</a>:</sub>/yubikey-val$ sudo make install
```</p></div>
<div class="paragraph"><p>The rest of this documentation will assume you have YK-VAL available
in the default installation targets.  You can override the paths, see
the Makefile.</p></div>
</div>
<div class="sect2">
<h3 id="_step_2_install_web_server_and_php">Step 2: Install web server and PHP</h3>
<div class="paragraph"><p>You also need to install a web server with PHP5, php5-curl and php-pear.</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:~$ sudo apt-get install apache2 php5 php5-curl php-pear
```</p></div>
<div class="paragraph"><p>Any web server with PHP support should work.</p></div>
</div>
<div class="sect2">
<h3 id="_step_3_database_installation">Step 3: Database installation</h3>
<div class="paragraph"><p>Any SQL database with PHP support should work.  We give examples for
MySQL and PostgreSQL here.  Note that you need to chose between either
PostgreSQL or MySQL here.</p></div>
<div class="sect3">
<h4 id="_step_3a_mysql_installation">Step 3A: MySQL Installation</h4>
<div class="paragraph"><p>Install the required packages:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:~$ sudo apt-get install mysql-server php5-mysql
```</p></div>
<div class="paragraph"><p>The installation asks you for a MySQL "root" password, and I recommend
to specify one. To avoid having to specify a password when using the
<em>mysql</em> tool interactively, you can store the password in ~/.my.cnf,
see /usr/share/doc/mysql-server-5.0/README.Debian.gz.  For example:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:~$ cat &gt; .my.cnf</p></div>
<div class="paragraph"><p>user = root
password = YOURPASSWORD
<a href="mailto:user@val">user@val</a>:<sub>$ chmod go-r .my.cnf
<a href="mailto:user@val">user@val</a>:</sub>$
```</p></div>
<div class="paragraph"><p>Note the <em>chmod</em> to protect your password from non-root users.</p></div>
<div class="paragraph"><p>The database needs to be initialized as follows:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ echo <em>create database ykval</em> | mysql
<a href="mailto:user@val">user@val</a>:</sub>$ mysql ykval &lt; /usr/share/doc/yubikey-val/ykval-db.sql
<a href="mailto:user@val">user@val</a>:~$
```</p></div>
<div class="paragraph"><p>You also need to create a database user for the verifier interface,
normally called <em>ykval_verifier</em>:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ mysql --silent ykval
mysql&gt; CREATE USER <em>ykval_verifier</em>@<em>localhost</em>; \
GRANT SELECT,INSERT,UPDATE(modified, yk_counter, yk_low, yk_high, yk_use, nonce) ON ykval.yubikeys TO <em>ykval_verifier</em>@<em>localhost</em>; \
GRANT SELECT(id, secret, active) ON ykval.clients TO <em>ykval_verifier</em>@<em>localhost</em>; \
GRANT SELECT,INSERT,UPDATE,DELETE ON ykval.queue TO <em>ykval_verifier</em>@<em>localhost</em>; \
SET PASSWORD FOR <em>ykval_verifier</em>@<em>localhost</em> = PASSWORD(<em>yourpassword</em>); \
FLUSH PRIVILEGES;
mysql&gt; \q
<a href="mailto:user@val">user@val</a>:</sub>$
```</p></div>
</div>
<div class="sect3">
<h4 id="_step_3b_postgresql_installation">Step 3B: PostgreSQL Installation</h4>
<div class="paragraph"><p>Install the required packages:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ sudo apt-get install postgresql php5-pgsql
&#8230;
<a href="mailto:user@val">user@val</a>:</sub>$
```</p></div>
<div class="paragraph"><p>The database needs to be initialized as follows:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ sudo su postgres
<a href="mailto:postgres@val">postgres@val</a>:</sub>$ createdb ykval
<a href="mailto:postgres@val">postgres@val</a>:<sub>$ psql ykval &lt; /usr/share/doc/yubikey-val/ykval-db.sql
<a href="mailto:postgres@val">postgres@val</a>:</sub>$
```</p></div>
<div class="paragraph"><p>You also need to create a database user for the verifier interface,
normally called <em>ykval_verifier</em>:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:postgres@val">postgres@val</a>:<sub>$ psql ykval -q
ykval=# CREATE USER ykval_verifier PASSWORD <em>yourpassword</em>;
ykval=# GRANT SELECT,INSERT,UPDATE ON yubikeys TO ykval_verifier;
ykval=# GRANT SELECT ON clients TO ykval_verifier;
ykval=# GRANT SELECT, INSERT, UPDATE, DELETE ON queue TO ykval_verifier;
ykval=# \q
<a href="mailto:postgres@val">postgres@val</a>:</sub>$
```</p></div>
<div class="paragraph"><p>Don&#8217;t forget to switch back to your normal user
```sh
<a href="mailto:postgres@val">postgres@val</a>:<sub>$ exit
<a href="mailto:user@val">user@val</a>:</sub>$
```</p></div>
<div class="paragraph"><p>During installation and debugging it may be useful to watch the
database log entries:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:~$ sudo tail -F /var/log/postgresql/postgresql-*-main.log &amp;
```</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_setup_verify_otp_interface">Step 4: Setup Verify OTP Interface</h3>
<div class="paragraph"><p>The interface to verify OTPs is implemented using a PHP script.  You
can place the script under any URL, but we recommend serving it as
<em>http://ykval.example.org/wsapi/verify</em>.  The simplest way to setup
the symlinks is to invoke <em>make symlink</em> in your YK-VAL source tree.
Like this:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>/yubikey-val$ sudo make symlink
install -d /var/www/wsapi/2.0
ln -sf /usr/share/yubikey-val/ykval-verify.php /var/www/wsapi/2.0/verify.php
ln -sf /usr/share/yubikey-val/ykval-sync.php /var/www/wsapi/2.0/sync.php
<a href="mailto:user@val">user@val</a>:</sub>/yubikey-val$
```</p></div>
<div class="paragraph"><p>If you want to do it manually, you can invoke the above commands
manually.</p></div>
</div>
<div class="sect2">
<h3 id="_step_5_include_path_configuration">Step 5: Include path configuration</h3>
<div class="paragraph"><p>Set the include path for the queue daemon by creating a file
/etc/default/ykval-queue with the following content:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ sudo sh -c <em>cat &gt; /etc/default/ykval-queue</em>
DAEMON_ARGS="/etc/yubico/val:/usr/share/yubikey-val"
<a href="mailto:user@val">user@val</a>:</sub>$
```</p></div>
<div class="paragraph"><p>You also need to set the include path for the PHP scripts running via
Apache, using a .htaccess file:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ sudo sh -c <em>cat &gt; /var/www/wsapi/2.0/.htaccess</em>
RewriteEngine on
RewriteRule <sup>([</sup>/\.\?]+)(\?.*)?$ $1.php$2 [L]
&lt;IfModule mod_php5.c&gt;
 php_value include_path ".:/etc/yubico/val:/usr/share/yubikey-val"
&lt;/IfModule&gt;
<a href="mailto:user@val">user@val</a>:</sub>$ sudo ln -s 2.0/.htaccess /var/www/wsapi/.htaccess
<a href="mailto:user@val">user@val</a>:~$
```</p></div>
<div class="paragraph"><p>The .htaccess file also sets up rewriting from the non-.PHP suffix URL
name to the right script.</p></div>
<div class="paragraph"><p>The paths are the default, if you installed the YK-VAL in some other
place you need to modify the paths.</p></div>
</div>
<div class="sect2">
<h3 id="_step_6_yk_val_configuration">Step 6: YK-VAL Configuration</h3>
<div class="paragraph"><p>You also need to create a ykval-config.php script.  An example file is
included in YK-VAL package as ykval-config.php</p></div>
<div class="paragraph"><p>A template is typically installed in /etc/yubico/val/ykval-config.php-template.</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ sudo cp /etc/yubico/val/ykval-config.php-template /etc/yubico/val/ykval-config.php
<a href="mailto:user@val">user@val</a>:</sub>$ sudo emacs -nw /etc/yubico/val/ykval-config.php
```</p></div>
<div class="paragraph"><p>Be careful about the user permissions and ownership so that unrelated
users on the system cannot read the database password.</p></div>
<div class="paragraph"><p>You will typically need to modify the DSN (<em>YKVAL_DB_DSN</em>), database
passwords (<em>YKVAL_DB_PW</em>), the sync pool lists (<em>YKVAL_SYNC_POOL</em>
and <em>YKVAL_ALLOWED_SYNC_POOL</em>), and the YK-KSM URLs inside the
otp2ksmurls function.</p></div>
<div class="paragraph"><p>An example DSN for a MySQL setup:</p></div>
<div class="paragraph"><p>```php
$baseParams[<em><em>YKVAL_DB_DSN</em></em>] = "mysql:dbname=ykval;host=127.0.0.1";
```</p></div>
<div class="paragraph"><p>An example DSN for a PostgreSQL setup:</p></div>
<div class="paragraph"><p>```php
$baseParams[<em><em>YKVAL_DB_DSN</em></em>] = "pgsql:dbname=ykval;host=127.0.0.1";
```</p></div>
<div class="paragraph"><p>We recommend to add the hosts in YKVAL_SYNC_POOL as entries in <em>/etc/hosts</em> to avoid network delays caused by DNS-lookups. For example:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ sudo sh -c <em>cat &gt;&gt; /etc/hosts</em>
1.2.3.4 api1.example.com
2.3.4.5 api2.example.com
<a href="mailto:user@val">user@val</a>:</sub>$
```</p></div>
<div class="paragraph"><p>To improve database performance you can use persistent database connection so that each request doesn&#8217;t require a new connection to be setup. To enable this modify <em><em>YKVAL_DB_OPTIONS</em></em> as follows:</p></div>
<div class="paragraph"><p>```php
$baseParams[<em><em>YKVAL_DB_OPTIONS</em></em>] = array(PDO::ATTR_PERSISTENT &#8658; true);
```</p></div>
</div>
<div class="sect2">
<h3 id="_step_7_apache_configuration">Step 7: Apache configuration</h3>
<div class="paragraph"><p>Create an apache web configuration file for the normal HTTP interface
like this:</p></div>
<div class="paragraph"><p>```
<a href="mailto:user@val">user@val</a>:~$ sudo sh -c <em>cat &gt; /etc/apache2/sites-available/ykval</em>
&lt;VirtualHost *:80&gt;
        ServerName api.example.com
        ServerAdmin <a href="mailto:support@example.com">support@example.com</a></p></div>
<div class="literalblock">
<div class="content">
<pre><code>DocumentRoot /var/www/
&lt;Directory /&gt;
        Options FollowSymLinks
        AllowOverride None
&lt;/Directory&gt;
&lt;Directory /var/www/&gt;
        Options FollowSymLinks
        AllowOverride All
        Order allow,deny
        allow from all
&lt;/Directory&gt;</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>ErrorLog /var/log/apache2/ykval-error.log
LogLevel warn</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>CustomLog /var/log/apache2/ykval-access.log "%h %l %u %t \"%r\" %&gt;s %b %D \"%{Referer}i\" \"%{User-Agent}i\""
ServerSignature On</code></pre>
</div></div>
<div class="paragraph"><p>&lt;/VirtualHost&gt;
<a href="mailto:user@val">user@val</a>:~$
```</p></div>
<div class="paragraph"><p>HTTPS is strictly speaking not required, but we strongly recommend it.</p></div>
<div class="paragraph"><p>You need to install a TLS stack for Apache, there are two popular
options here: mod_gnutls and mod_ssl.  We&#8217;ll explain how to install
both, but you will need to decide which one to use.</p></div>
<div class="paragraph"><p>You will need to create a key/certificate for your server using normal
tools like GnuTLS "certtool".  A small howto for !GoDaddy is available
from
[<a href="http://permalink.gmane.org/gmane.comp.encryption.gpg.gnutls.devel/4062">http://permalink.gmane.org/gmane.comp.encryption.gpg.gnutls.devel/4062</a>].</p></div>
<div class="sect3">
<h4 id="_step_7a_https_via_mod_gnutls">Step 7A: HTTPS via mod_gnutls</h4>
<div class="paragraph"><p>First install and enable the mod_gnutls module:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ sudo apt-get install libapache2-mod-gnutls
<a href="mailto:user@val">user@val</a>:</sub>$ sudo a2enmod gnutls
Enabling module gnutls.
Run <em>/etc/init.d/apache2 restart</em> to activate new configuration!
<a href="mailto:user@val">user@val</a>:~$
```</p></div>
<div class="paragraph"><p>You will need to place the private key in
/etc/ssl/private/api.example.com-key.pem and the certificate chain in
/etc/ssl/private/api.example.com-chain.pem.</p></div>
<div class="paragraph"><p>Create Apache web configuration files:</p></div>
<div class="paragraph"><p>```
<a href="mailto:user@val">user@val</a>:~$ sudo sh -c <em>cat &gt; /etc/apache2/sites-available/ykval-ssl</em>
Listen 443
&lt;VirtualHost *:443&gt;
        ServerName api.example.com
        ServerAdmin <a href="mailto:support@example.com">support@example.com</a></p></div>
<div class="literalblock">
<div class="content">
<pre><code>GnuTLSEnable on
GnuTLSCertificateFile /etc/ssl/private/api.example.com-chain.pem
GnuTLSKeyFile /etc/ssl/private/api.example.com-key.pem
GnuTLSPriorities NORMAL</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>DocumentRoot /var/www/
&lt;Directory /&gt;
        Options FollowSymLinks
        AllowOverride None
&lt;/Directory&gt;
&lt;Directory /var/www/&gt;
        Options FollowSymLinks
        AllowOverride All
        Order allow,deny
        allow from all
&lt;/Directory&gt;</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>ErrorLog /var/log/apache2/ykval-ssl-error.log
LogLevel warn</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>CustomLog /var/log/apache2/ykval-ssl-access.log "%h %l %u %t \"%r\" %&gt;s %b %D \"%{Referer}i\" \"%{User-Agent}i\""
ServerSignature On</code></pre>
</div></div>
<div class="paragraph"><p>&lt;/VirtualHost&gt;
<a href="mailto:user@val">user@val</a>:~$
```</p></div>
</div>
<div class="sect3">
<h4 id="_step_7b_https_via_mod_ssl">Step 7B: HTTPS via mod_ssl</h4>
<div class="paragraph"><p>The mod_ssl module is typically installed by default, but you need to
enable it.</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ sudo a2enmod ssl
Enabling module ssl.
Run <em>/etc/init.d/apache2 restart</em> to activate new configuration!
<a href="mailto:user@val">user@val</a>:</sub>$
```</p></div>
<div class="paragraph"><p>You will need to place the private key in
/etc/ssl/private/api.example.com-key.pem and the certificate chain in
/etc/ssl/private/api.example.com-chain.pem.</p></div>
<div class="paragraph"><p>```
<a href="mailto:user@val">user@val</a>:~$ sudo sh -c <em>cat &gt; /etc/apache2/sites-available/ykval-ssl</em>
&lt;VirtualHost *:443&gt;
        ServerName api.example.com
        ServerAdmin <a href="mailto:support@example.com">support@example.com</a></p></div>
<div class="literalblock">
<div class="content">
<pre><code>SSLEngine on
SSLCertificateFile /etc/ssl/private/api.example.com-chain.pem
SSLCertificateChainFile /etc/ssl/private/api.example.com-chain.pem
SSLCertificateKeyFile /etc/ssl/private/api.example.com-key.pem</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>DocumentRoot /var/www/
&lt;Directory /&gt;
        Options FollowSymLinks
        AllowOverride None
&lt;/Directory&gt;
&lt;Directory /var/www/&gt;
        Options FollowSymLinks
        AllowOverride All
        Order allow,deny
        allow from all
&lt;/Directory&gt;</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>ErrorLog /var/log/apache2/ykval-ssl-error.log
LogLevel warn</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>CustomLog /var/log/apache2/ykval-ssl-access.log "%h %l %u %t \"%r\" %&gt;s %b %D \"%{Referer}i\" \"%{User-Agent}i\""
ServerSignature On</code></pre>
</div></div>
<div class="paragraph"><p>&lt;/VirtualHost&gt;
<a href="mailto:user@val">user@val</a>:~$
```</p></div>
</div>
<div class="sect3">
<h4 id="_common_apache_configuration">Common Apache Configuration</h4>
<div class="paragraph"><p>This step is the same for both mod_gnutls and mod_ssl.</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ sudo a2enmod rewrite
Enabling module rewrite.
Run <em>/etc/init.d/apache2 restart</em> to activate new configuration!
<a href="mailto:user@val">user@val</a>:</sub>$ sudo a2dissite default
Site default disabled.
Run <em>/etc/init.d/apache2 reload</em> to activate new configuration!
<a href="mailto:user@val">user@val</a>:<sub>$ sudo a2ensite ykval ykval-ssl
Enabling site ykval.
Enabling site ykval-ssl.
Run <em>/etc/init.d/apache2 reload</em> to activate new configuration!
<a href="mailto:user@val">user@val</a>:</sub>$ sudo /etc/init.d/apache2 restart
<a href="mailto:user@val">user@val</a>:~$
```</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_step_8_logging">Step 8: Logging</h3>
<div class="paragraph"><p>The PHP interface uses syslog for logging of incoming requests.  The
facility is LOG_LOCAL0.  To place these messages in a separate file,
you can add the following to /etc/syslog.conf, or if you use rsyslog,
create a file /etc/rsyslog.d/ykval.conf with this content:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ sudo sh -c <em>cat &gt; /etc/rsyslog.d/ykval.conf</em>
local0.* -/var/log/ykval.log
<a href="mailto:user@val">user@val</a>:</sub>$ sudo /etc/init.d/rsyslog restart
&#8230;
<a href="mailto:user@val">user@val</a>:~$
```</p></div>
<div class="paragraph"><p>The <em>-</em> before the filename avoids syncing the file after each write,
which is recommended for performance.</p></div>
<div class="paragraph"><p>The log file can grow large quickly, so it is a good idea to setup
rotation of log files.  Here is an example that rotates the log file
weekly.  Create a file /etc/logrotate.d/ykval like this:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:<sub>$ sudo sh -c <em>cat &gt; /etc/logrotate.d/ykval</em>
/var/log/ykval.log {
        weekly
        dateext
        compress
        missingok
        rotate 9999
        notifempty
        postrotate
                invoke-rc.d rsyslog reload &gt; /dev/null
        endscript
}
<a href="mailto:user@val">user@val</a>:</sub>$
```</p></div>
<div class="paragraph"><p>You may want to modify the default /etc/logrotate.d/apache2, useful
things to add are <em>dateext</em> and <em>compress</em> and change <em>rotate</em> to
something large if you want to retain logs.</p></div>
</div>
<div class="sect2">
<h3 id="_step_8_1_fix_default_log_optional">Step 8.1: Fix default log (optional)</h3>
<div class="paragraph"><p>Unfortunately, most default syslog configuration, including the
syslog.conf configuration file on Debian, will also log all entries to
/var/log/syslog and/or /var/log/messages.</p></div>
<div class="paragraph"><p>I am not aware of any way to avoid this without modifying these other
rules.  To avoid YK-VAL log entries in these other files, you must
modify the default rules.  For example, edit the following lines of
/etc/rsyslog.conf (or /etc/syslog.conf if you don&#8217;t use rsyslog):</p></div>
<div class="paragraph"><p>```
<strong>.=debug;\
        auth,authpriv.none;\
        news.none;mail.none     -/var/log/debug
*.</strong>;auth,authpriv.none          -/var/log/syslog
<strong>.=info;</strong>.=notice;*.=warn;\
        auth,authpriv.none;\
        cron,daemon.none;\
        mail,news.none          -/var/log/messages
```</p></div>
<div class="paragraph"><p>Change them into:</p></div>
<div class="paragraph"><p>```
<strong>.=debug;\
        auth,authpriv.none;\
        news.none;mail.none;local0.none     -/var/log/debug
*.</strong>;auth,authpriv.none,local0.none              -/var/log/syslog
<strong>.=info;</strong>.=notice;*.=warn;\
        auth,authpriv.none;\
        cron,daemon.none;\
        local0.none;\
        mail,news.none          -/var/log/messages
```</p></div>
<div class="paragraph"><p>Idempotent commands to speed this up:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@host">user@host</a>:<sub>$ sudo perl -pi -e <em>s/;auth,authpriv.none/;auth,local0.none,authpriv.none/</em> /etc/rsyslog.conf
<a href="mailto:user@host">user@host</a>:</sub>$ sudo perl -pi -e <em>s/news.none;mail.none/news.none;local0.none;mail.none/</em> /etc/rsyslog.conf
<a href="mailto:user@host">user@host</a>:<sub>$ sudo perl -pi -e <em>s/cron,daemon.none/cron,daemon.none;local0.none/</em> /etc/rsyslog.conf
<a href="mailto:user@host">user@host</a>:</sub>$ sudo /etc/init.d/rsyslog restart
```</p></div>
</div>
<div class="sect2">
<h3 id="_step_9_start_sync_daemon">Step 9: Start Sync Daemon</h3>
<div class="paragraph"><p>When using yubikey-val in a sync pool, you need to have the ykval-queue
daemon running to ensure that data is synchronized between the servers in
the pool. The easiest way of running this is to simply invoke ykval-queue
in a shell:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:~$ sudo ykval-queue
```</p></div>
<div class="paragraph"><p>However, the recommended approach is to automate running this process in
the background, by use of an init script or similar. Instructions on doing
so vary depending on your operating system.</p></div>
</div>
<div class="sect2">
<h3 id="_step_10_sync_data_from_an_existing_server_optional">Step 10: Sync data from an existing server (optional)</h3>
<div class="paragraph"><p>If you&#8217;re adding a new server to an existing pool, you can synchronize all
YubiKey counter data from one of the existing servers. To do so, the server
you want to sync from needs to be configured to allow it. Do this by editing
/etc/yubico/val/ykval-config.php on the existing server, adding the new
servers IP address to the <em>YKRESYNC_IPS</em> setting. You&#8217;ll most likely want
to add the IP to the <em>YKVAL_ALLOWED_SYNC_POOL</em> setting as well. You also
need to edit this file on the new server, adding the existing server(s) IP
address(es) to <em>YKVAL_ALLOWED_SYNC_POOL</em>.</p></div>
<div class="paragraph"><p>Once these permissions have been configured, you can initiate the full sync
by running the following command from the new server:
```sh
<a href="mailto:user@val">user@val</a>:~$ ykval-synchronize <a href="http://&lt;IP">http://&lt;IP</a> or hostname of existing server&gt;/wsapi/2.0/resync all
```</p></div>
</div>
<div class="sect2">
<h3 id="_step_11_test_it">Step 11: Test it</h3>
<div class="paragraph"><p>You can test the service by requesting a URL.  Using wget, for
example:</p></div>
<div class="paragraph"><p>```sh
<a href="mailto:user@val">user@val</a>:~$ wget -q -O - <em>http://localhost/wsapi/2.0/verify?id=1&amp;nonce=asdmalksdmlkasmdlkasmdlakmsdaasklmdlak&amp;otp=dteffujehknhfjbrjnlnldnhcujvddbikngjrtgh</em>
h=/QVWkl5VlcX+Or1A2b3vOeoLEwI=
t=2010-05-17T14:48:15Z0355
otp=dteffujehknhfjbrjnlnldnhcujvddbikngjrtgh
nonce=asdmalksdmlkasmdlkasmdlakmsdaasklmdlak
status=NO_SUCH_CLIENT</p></div>
<div class="paragraph"><p><a href="mailto:user@val">user@val</a>:~$
```</p></div>
<div class="paragraph"><p>Naturally, you will need to import client keys into the database for
the verify function to work properly.</p></div>
</div>
<div class="sect2">
<h3 id="_the_end">The End</h3>
<div class="paragraph"><p>You now have a YK-VAL up and running.  See
[<a href="https://github.com/Yubico/yubikey-ksm/wiki/ServerHardening">https://github.com/Yubico/yubikey-ksm/wiki/ServerHardening</a>] on how to
improve security of your system.</p></div>
</div>
</div>
</div>

</section>
</div>

<!-- FOOTER  -->
<div id="footer_wrap" class="outer">
<footer class="inner">
<p class="copyright">yubikey-val maintained by <a href="https://github.com/Yubico">Yubico</a></p>
<p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
</footer>
</div></body></html>
