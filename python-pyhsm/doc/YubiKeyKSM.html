<!DOCTYPE html>
<html>

  <head>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6195355-4', 'yubico.com');
  ga('send', 'pageview');

</script>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="python-pyhsm : Python code for YubiHSM" />

    <link rel="stylesheet" type="text/css" media="screen" href="/stylesheets/stylesheet.css">

    <title>python-pyhsm</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
        <span class="breadcrumb">
          <a href="/">Software listing</a>
          /
          <a href="/python-pyhsm/">python-pyhsm</a>
          /
          <a>YubiKeyKSM</a>
          </span>
          <a id="forkme_banner" href="https://github.com/Yubico/python-pyhsm">View on GitHub</a>

          <h1><a id="project_title" href="/python-pyhsm/">python-pyhsm</a></h1>
          <h2 id="project_tagline">Python code for YubiHSM</h2>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
<div class="paragraph"><p>YubiKey Key Storage Module using the YubiHSM</p></div>
<div class="paragraph"><p><strong>Introduction</strong></p></div>
<div class="paragraph"><p>The YubiCloud architecture separates the online validation servers where
queries are sent from the place where the actual secret YubiKey AES keys
are stored. The KSM decrypts the YubiKey OTP using the AES key identified
by the "public id" part of the OTP, and return the counter values of the
OTP to the querying validation server, which decides if the OTP is valid
or not.</p></div>
<div class="paragraph"><p>The application "yubikey-ksm" bundled with pyhsm is a KSM backend using
the YubiHSM to further protect the AES keys.</p></div>
<div class="paragraph"><p>The interface exposed to the validation servers is a simple REST web
interface, currently implemented using the BaseHTTPServer. It is inter-
changeable with the original PHP based KSM found at
<a href="https://developers.yubico.com/yubikey-ksm/">https://developers.yubico.com/yubikey-ksm/</a></p></div>
<div class="paragraph"><p><strong>Be aware</strong> that it is currently single threaded, and uses a short timeout
(5 seconds per default) to prevent blocking on bad requests (typically
network problems between a validation server and a KSM).</p></div>
<div class="paragraph"><p><strong>Key handle</strong>
You need to configure the YubiHSM connected to the KSM server with at least
one key handle that has the YSM_AEAD_OTP_DECODE permission flag set.</p></div>
<div class="paragraph"><p>It is preferable to use a separate server (and YubiHSM) to create AEAD:s,
in which case the other YubiHSM will have the same key handle with the
same secret key, but with different permission flags (the appropriate
YSM AEAD generate flags for the type of keys you use).</p></div>
<div class="paragraph"><p><strong>Installation on Debian/Ubuntu</strong></p></div>
<div class="paragraph"><p>You can install the yhsm-yubikey-ksm from the package repositories :</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ sudo apt-get install yhsm-yubikey-ksm
$ sudo $EDITOR /etc/default/yhsm-yubikey-ksm</code></pre>
</div></div>
<div class="paragraph"><p><strong>Non-Debian/Ubuntu installation instructions</strong></p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Install pyhsm (see README in top level of pyhsm)
</p>
</li>
<li>
<p>
Install yhsm-yubikey-ksm into a suitable directory such as /usr/local/sbin/
</p>
</li>
<li>
<p>
Run yhsm-yubikey-ksm --help to see what options are available. You will need to
  supply <strong>--key-handles</strong>, and possibly other parameters (verify --output-dir for
  example).
</p>
</li>
</ol></div>
<div class="paragraph"><p><strong>The AEAD files</strong></p></div>
<div class="paragraph"><p>yhsm-yubikey-ksm is supposed to work with at least a couple of million YubiKeys
(although the use of BaseHTTPServer might prove to be a bit too simplistic for
a validation service of that magnitude, since it is not threaded).</p></div>
<div class="paragraph"><p>To keep things (such as adding new keys to a non-stop service) simple, and thereby
hopefully robust, the initial scheme is to use the filesystem as database. We store
the secrets of every YubiKey (22 bytes) in a separate file.</p></div>
<div class="paragraph"><p>The secrets are randomized and encrypted by a YubiHSM (preferably a separate one at
a key provisioning site) so that they are protected from attackers even if they were
to gain administrative access to the server/servers with YubiHSM&#8217;s attached to them.</p></div>
<div class="paragraph"><p>The YubiHSM adds a MAC of 8 bytes to the 22 bytes secret data of the YubiKey,
resulting in an AEAD of 30 bytes. This data is opaque by nature to everyone but the
YubiHSM, since it is the only one with the key to decrypt the AEAD.</p></div>
<div class="paragraph"><p>Most filesystems start under-performing if you put a million files in a single
directory. To avoid that, the AEAD file is hashed into a directory for each octet
but the last one in the public ID. This ensures there will never be more than 256
AEAD files in each directory :</p></div>
<div class="listingblock">
<div class="content">
<pre><code>public id     key handle  AEAD file
ccbbddeeffcc  0x20        /var/cache/yubikey-ksm/aeads/0x20/cc/bb/dd/ee/ff/ccbbddeeffcc</code></pre>
</div></div>
<div class="paragraph"><p>An important note for storing large numbers of AEAD files in a filesystem is that it
will use up large numbers of inodes. Consideration for this should be taken into
account when setting up the filesystem.</p></div>
<div class="paragraph"><p><strong>Importing YubiKey secrets</strong></p></div>
<div class="paragraph"><p>If you had a YK-KSM server before getting a YubiHSM, use the export utility to
export all the secrets into a text file of this format :</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ykksm 1
123456,ftftftcccccc,534543524554,fcacd309a20ce1809c2db257f0e8d6ea,000000000000,,,
...</code></pre>
</div></div>
<div class="paragraph"><p>and then use the import utility /usr/sbin/yhsm-import-keys to create AEAD&#8217;s for
all YubiKey&#8217;s listed in the text file.</p></div>

</section>
</div>

<!-- FOOTER  -->
<div id="footer_wrap" class="outer">
<footer class="inner">
<p class="copyright">python-pyhsm maintained by <a href="https://github.com/Yubico">Yubico</a></p>
</footer>
</div></body></html>
